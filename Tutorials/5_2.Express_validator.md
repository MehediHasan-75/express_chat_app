# ðŸ“š Complete MongoDB & Mongoose Guide

## ðŸ“– Table of Contents
- [SQL vs NoSQL Basics](#sql-vs-nosql-basics)
- [MongoDB Installation](#mongodb-installation)
- [MongoDB Shell Commands](#mongodb-shell-commands)
- [Mongoose Setup & Benefits](#mongoose-setup--benefits)
- [Complete Mongoose Workflow](#complete-mongoose-workflow)
- [Schema & Models](#schema--models)
- [CRUD Operations with Mongoose](#crud-operations-with-mongoose)
- [Advanced Mongoose Features](#advanced-mongoose-features)

---

## ðŸ”„ SQL vs NoSQL Basics

### Terminology Mapping
| SQL | NoSQL (MongoDB) |
|-----|-----------------|
| Database | Database |
| Table | Collection |
| Row | Document |
| Column | Field |
| Query Language: SQL | Query Language: NoSQL |

### Key Difference
- **MongoDB stores data in Binary JSON (BSON)** format for efficient storage and retrieval

---

## ðŸ’¾ MongoDB Installation

### 1. Install MongoDB Community Server
```bash
# Download from: https://www.mongodb.com/try/download/community
# Follow installation wizard for your OS

# For Ubuntu/Debian
wget -qO - https://www.mongodb.org/static/pgp/server-6.0.asc | sudo apt-key add -
sudo apt-get install -y mongodb-org

# For macOS
brew tap mongodb/brew
brew install mongodb-community
```

### 2. Start MongoDB Service
```bash
# Linux
sudo systemctl start mongod
sudo systemctl enable mongod

# macOS
brew services start mongodb-community

# Windows
# MongoDB runs as a service automatically after installation
```

### 3. Install MongoDB Compass (GUI)
- Download from: https://www.mongodb.com/try/download/compass
- Provides visual interface for database management

### 4. Verify Installation
```bash
mongosh --version
# or
mongo --version
```

---

## ðŸ–¥ï¸ MongoDB Shell Commands

### Connect to MongoDB
```bash
# Enter shell
mongosh

# Connect to remote MongoDB
mongosh "mongodb://username:password@host:27017"

# Help commands
help
db.help()
db.collection.help()
```

### Database Commands
```javascript
// Show all databases
show dbs

// Switch/Create database
use school

// Show current database
db

// Drop database
db.dropDatabase()
```

### Collection Commands
```javascript
// Show all collections
show collections

// Create collection
db.createCollection("students")

// Drop collection
db.students.drop()

// Rename collection
db.students.renameCollection("pupils")
```

### INSERT Operations
```javascript
// Insert One Document
db.students.insertOne({
  name: "Mehedi",
  age: 22,
  dept: "CSE",
  email: "mehedi@example.com"
})

// Insert Many Documents
db.students.insertMany([
  { name: "Tamim", age: 24, dept: "SWE" },
  { name: "Rahim", age: 21, dept: "EEE" }
])
```

### FIND Operations (READ)
```javascript
// Find all documents
db.students.find()

// Pretty formatted output
db.students.find().pretty()

// Find with filter
db.students.find({ dept: "CSE" })

// Find one document
db.students.findOne({ name: "Mehedi" })

// Projection (select specific fields)
db.students.find({}, { name: 1, age: 1, _id: 0 })

// Comparison operators
db.students.find({ age: { $gt: 20 } })      // greater than
db.students.find({ age: { $lt: 25 } })      // less than
db.students.find({ age: { $gte: 22 } })     // greater than or equal
db.students.find({ age: { $lte: 23 } })     // less than or equal
db.students.find({ age: { $eq: 22 } })      // equal
db.students.find({ age: { $ne: 22 } })      // not equal

// Logical operators
db.students.find({
  $and: [{ dept: "CSE" }, { age: { $gt: 20 } }]
})

db.students.find({
  $or: [{ dept: "CSE" }, { dept: "SWE" }]
})

// $in and $nin
db.students.find({ dept: { $in: ["CSE", "EEE"] } })
db.students.find({ dept: { $nin: ["SWE"] } })

// Sorting
db.students.find().sort({ age: 1 })    // ascending
db.students.find().sort({ age: -1 })   // descending

// Pagination
db.students.find().limit(5)            // limit results
db.students.find().skip(10)            // skip first 10
db.students.find().skip(10).limit(5)   // pagination

// Count documents
db.students.countDocuments()
db.students.countDocuments({ dept: "CSE" })
```

### UPDATE Operations
```javascript
// Update one document
db.students.updateOne(
  { name: "Mehedi" },
  { $set: { age: 23 } }
)

// Update many documents
db.students.updateMany(
  { dept: "CSE" },
  { $set: { semester: "8th" } }
)

// Replace entire document
db.students.replaceOne(
  { name: "Rahim" },
  { name: "Rahim", age: 22, dept: "Math" }
)

// Update operators
// $inc - increment value
db.students.updateOne(
  { name: "Mehedi" },
  { $inc: { age: 1 } }
)

// $unset - remove field
db.students.updateOne(
  { name: "Mehedi" },
  { $unset: { semester: "" } }
)

// $push - add to array
db.students.updateOne(
  { name: "Mehedi" },
  { $push: { skills: "MongoDB" } }
)

// $addToSet - add to array (avoid duplicates)
db.students.updateOne(
  { name: "Mehedi" },
  { $addToSet: { skills: "Node.js" } }
)

// $pull - remove from array
db.students.updateOne(
  { name: "Mehedi" },
  { $pull: { skills: "PHP" } }
)

// $pop - remove first/last element
db.students.updateOne(
  { name: "Mehedi" },
  { $pop: { skills: 1 } }  // 1 for last, -1 for first
)

// $rename - rename field
db.students.updateOne(
  { name: "Mehedi" },
  { $rename: { "dept": "department" } }
)
```

### DELETE Operations
```javascript
// Delete one document
db.students.deleteOne({ name: "Tamim" })

// Delete many documents
db.students.deleteMany({ age: { $lt: 20 } })

// Delete all documents in collection
db.students.deleteMany({})
```

### Indexes
```javascript
// Create index
db.students.createIndex({ name: 1 })

// Unique index
db.students.createIndex({ email: 1 }, { unique: true })

// Compound index
db.students.createIndex({ dept: 1, age: -1 })

// List indexes
db.students.getIndexes()

// Drop index
db.students.dropIndex("name_1")

// Text index for search
db.students.createIndex({ name: "text", dept: "text" })

// Text search
db.students.find({ $text: { $search: "CSE" } })
```

### Aggregation Pipeline
```javascript
// Group and count
db.students.aggregate([
  { $group: { _id: "$dept", total: { $sum: 1 } } }
])

// Group with average
db.students.aggregate([
  { $group: { _id: "$dept", avgAge: { $avg: "$age" } } },
  { $sort: { avgAge: -1 } }
])

// Match and project
db.students.aggregate([
  { $match: { dept: "CSE" } },
  { $project: { name: 1, age: 1, _id: 0 } }
])

// Unwind arrays
db.students.aggregate([
  { $unwind: "$skills" }
])

// Lookup (JOIN)
db.orders.aggregate([
  {
    $lookup: {
      from: "customers",
      localField: "customer_id",
      foreignField: "_id",
      as: "customerDetails"
    }
  }
])
```

---

## ðŸš€ Mongoose Setup & Benefits

### Installation
```bash
npm install mongoose
```

### Why Mongoose over MongoDB Driver?

**Mongoose** = Elegant Object Data Modeling (ODM)

#### Architecture Flow
```
Node.js â†’ Mongoose â†’ MongoDB Driver â†’ MongoDB
|                                            |
|----------Object Mapping-------------------|
```

#### Benefits of Mongoose
1. âœ… **Abstraction** from raw low-level MongoDB operations
2. âœ… **Relationships** between NoSQL data
3. âœ… **Schema validation** for data consistency
4. âœ… **Object Data Mapping** - Translation between database and JavaScript objects
5. âœ… **40-60% less code** compared to raw MongoDB package
6. âœ… **Middleware support** (pre/post hooks)
7. âœ… **Built-in type casting**
8. âœ… **Query building** with chainable methods

---

## ðŸ”§ Complete Mongoose Workflow

### Step 1: Connect to MongoDB

```javascript
// db.js or config/database.js
const mongoose = require('mongoose');

const connectDB = async () => {
  try {
    await mongoose.connect('mongodb://localhost:27017/school', {
      useNewUrlParser: true,
      useUnifiedTopology: true,
    });
    console.log('âœ… MongoDB Connected Successfully');
  } catch (error) {
    console.error('âŒ MongoDB Connection Error:', error);
    process.exit(1);
  }
};

module.exports = connectDB;
```

### Step 2: Create Schema & Model

```javascript
// models/Student.js
const mongoose = require('mongoose');

// Define Schema
const studentSchema = new mongoose.Schema({
  name: {
    type: String,
    required: [true, 'Name is required'],
    trim: true,
    minlength: [3, 'Name must be at least 3 characters'],
    maxlength: [50, 'Name cannot exceed 50 characters']
  },
  email: {
    type: String,
    required: true,
    unique: true,
    lowercase: true,
    match: [/^\S+@\S+\.\S+$/, 'Please provide a valid email']
  },
  age: {
    type: Number,
    required: true,
    min: [18, 'Age must be at least 18'],
    max: [100, 'Age cannot exceed 100']
  },
  dept: {
    type: String,
    required: true,
    enum: ['CSE', 'SWE', 'EEE', 'Math'],
    default: 'CSE'
  },
  skills: {
    type: [String],
    default: []
  },
  isActive: {
    type: Boolean,
    default: true
  },
  semester: {
    type: String,
    enum: ['1st', '2nd', '3rd', '4th', '5th', '6th', '7th', '8th']
  },
  address: {
    city: String,
    country: {
      type: String,
      default: 'Bangladesh'
    }
  },
  enrollmentDate: {
    type: Date,
    default: Date.now
  }
}, {
  timestamps: true  // Adds createdAt and updatedAt fields
});

// Create Model
const Student = mongoose.model('Student', studentSchema);

module.exports = Student;
```

### Step 3: Use in Application

```javascript
// app.js or index.js
const express = require('express');
const connectDB = require('./db');
const Student = require('./models/Student');

const app = express();
app.use(express.json());

// Connect to database
connectDB();

// Routes will go here...

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`ðŸš€ Server running on port ${PORT}`);
});
```

---

## ðŸ“‹ Schema & Models

### Schema Definition

A **Schema** is like a JavaScript object that gives data a proper structure and validation rules.

```javascript
const mongoose = require('mongoose');

const userSchema = new mongoose.Schema({
  // String types
  username: String,
  
  // With validation
  email: {
    type: String,
    required: true,
    unique: true
  },
  
  // Number types
  age: Number,
  
  // Boolean
  isVerified: {
    type: Boolean,
    default: false
  },
  
  // Date
  birthDate: Date,
  
  // Array
  hobbies: [String],
  
  // Nested object
  profile: {
    bio: String,
    website: String
  },
  
  // Reference to another model
  posts: [{
    type: mongoose.Schema.Types.ObjectId,
    ref: 'Post'
  }],
  
  // Mixed type (any type)
  metadata: mongoose.Schema.Types.Mixed
});
```

### Schema Options

```javascript
const schema = new mongoose.Schema({
  // fields...
}, {
  timestamps: true,        // Adds createdAt, updatedAt
  versionKey: false,       // Removes __v field
  collection: 'users',     // Custom collection name
  toJSON: { virtuals: true },  // Include virtuals in JSON
  toObject: { virtuals: true } // Include virtuals in objects
});
```

### Schema Validation

```javascript
const productSchema = new mongoose.Schema({
  name: {
    type: String,
    required: [true, 'Product name is required'],
    trim: true,
    minlength: [3, 'Name too short'],
    maxlength: [100, 'Name too long']
  },
  price: {
    type: Number,
    required: true,
    min: [0, 'Price cannot be negative'],
    validate: {
      validator: function(v) {
        return v > 0;
      },
      message: 'Price must be greater than 0'
    }
  },
  category: {
    type: String,
    enum: {
      values: ['Electronics', 'Clothing', 'Books'],
      message: '{VALUE} is not a valid category'
    }
  },
  email: {
    type: String,
    match: [/^\S+@\S+\.\S+$/, 'Invalid email format']
  }
});
```

---

## ðŸ”¨ CRUD Operations with Mongoose

### CREATE Operations

```javascript
// Method 1: Using create()
const createStudent = async () => {
  try {
    const student = await Student.create({
      name: 'Mehedi Hasan',
      email: 'mehedi@example.com',
      age: 22,
      dept: 'CSE',
      skills: ['JavaScript', 'Node.js', 'MongoDB']
    });
    console.log('âœ… Student created:', student);
  } catch (error) {
    console.error('âŒ Error:', error.message);
  }
};

// Method 2: Using new + save()
const createStudentAlt = async () => {
  try {
    const student = new Student({
      name: 'Tamim Ahmed',
      email: 'tamim@example.com',
      age: 24,
      dept: 'SWE'
    });
    await student.save();
    console.log('âœ… Student saved:', student);
  } catch (error) {
    console.error('âŒ Error:', error.message);
  }
};

// Insert multiple documents
const createMany = async () => {
  try {
    const students = await Student.insertMany([
      { name: 'Rahim', email: 'rahim@example.com', age: 21, dept: 'EEE' },
      { name: 'Karim', email: 'karim@example.com', age: 23, dept: 'Math' }
    ]);
    console.log('âœ… Students created:', students.length);
  } catch (error) {
    console.error('âŒ Error:', error.message);
  }
};
```

### READ Operations

```javascript
// Find all documents
const findAll = async () => {
  const students = await Student.find();
  console.log(students);
};

// Find with filter
const findByDept = async () => {
  const students = await Student.find({ dept: 'CSE' });
  console.log(students);
};

// Find one document
const findOne = async () => {
  const student = await Student.findOne({ email: 'mehedi@example.com' });
  console.log(student);
};

// Find by ID
const findById = async (id) => {
  const student = await Student.findById(id);
  console.log(student);
};

// Find with query operators
const findWithOperators = async () => {
  // Greater than
  const students1 = await Student.find({ age: { $gt: 20 } });
  
  // Multiple conditions
  const students2 = await Student.find({
    dept: 'CSE',
    age: { $gte: 22, $lte: 25 }
  });
  
  // OR condition
  const students3 = await Student.find({
    $or: [{ dept: 'CSE' }, { dept: 'SWE' }]
  });
  
  // IN operator
  const students4 = await Student.find({
    dept: { $in: ['CSE', 'EEE'] }
  });
  
  console.log(students1, students2, students3, students4);
};

// Find with projection (select specific fields)
const findWithProjection = async () => {
  // Include only name and email
  const students = await Student.find({}, 'name email');
  
  // Exclude certain fields
  const students2 = await Student.find().select('-__v -createdAt');
  
  console.log(students, students2);
};

// Find with sorting
const findWithSort = async () => {
  // Ascending
  const students1 = await Student.find().sort({ age: 1 });
  
  // Descending
  const students2 = await Student.find().sort({ age: -1 });
  
  // Multiple sort
  const students3 = await Student.find().sort({ dept: 1, age: -1 });
  
  console.log(students1, students2, students3);
};

// Find with pagination
const findWithPagination = async (page = 1, limit = 10) => {
  const skip = (page - 1) * limit;
  
  const students = await Student.find()
    .skip(skip)
    .limit(limit)
    .sort({ createdAt: -1 });
  
  const total = await Student.countDocuments();
  
  return {
    students,
    page,
    totalPages: Math.ceil(total / limit),
    totalStudents: total
  };
};

// Count documents
const countDocs = async () => {
  const total = await Student.countDocuments();
  const cseCount = await Student.countDocuments({ dept: 'CSE' });
  
  console.log(`Total: ${total}, CSE: ${cseCount}`);
};

// Check if exists
const checkExists = async () => {
  const exists = await Student.exists({ email: 'mehedi@example.com' });
  console.log('Exists:', exists); // Returns { _id: ... } or null
};
```

### UPDATE Operations

```javascript
// Update one document
const updateOne = async () => {
  const result = await Student.updateOne(
    { email: 'mehedi@example.com' },
    { $set: { age: 23 } }
  );
  console.log('Modified:', result.modifiedCount);
};

// Update many documents
const updateMany = async () => {
  const result = await Student.updateMany(
    { dept: 'CSE' },
    { $set: { semester: '8th' } }
  );
  console.log('Modified:', result.modifiedCount);
};

// Find and update (returns updated document)
const findOneAndUpdate = async () => {
  const student = await Student.findOneAndUpdate(
    { email: 'mehedi@example.com' },
    { $set: { age: 24 } },
    { new: true, runValidators: true }  // new: true returns updated doc
  );
  console.log('Updated student:', student);
};

// Find by ID and update
const findByIdAndUpdate = async (id) => {
  const student = await Student.findByIdAndUpdate(
    id,
    { $set: { age: 25 } },
    { new: true }
  );
  console.log('Updated student:', student);
};

// Update with operators
const updateWithOperators = async () => {
  // Increment
  await Student.updateOne(
    { email: 'mehedi@example.com' },
    { $inc: { age: 1 } }
  );
  
  // Add to array
  await Student.updateOne(
    { email: 'mehedi@example.com' },
    { $push: { skills: 'React' } }
  );
  
  // Add to array (avoid duplicates)
  await Student.updateOne(
    { email: 'mehedi@example.com' },
    { $addToSet: { skills: 'TypeScript' } }
  );
  
  // Remove from array
  await Student.updateOne(
    { email: 'mehedi@example.com' },
    { $pull: { skills: 'PHP' } }
  );
  
  // Remove field
  await Student.updateOne(
    { email: 'mehedi@example.com' },
    { $unset: { semester: '' } }
  );
};
```

### DELETE Operations

```javascript
// Delete one document
const deleteOne = async () => {
  const result = await Student.deleteOne({ email: 'test@example.com' });
  console.log('Deleted:', result.deletedCount);
};

// Delete many documents
const deleteMany = async () => {
  const result = await Student.deleteMany({ age: { $lt: 20 } });
  console.log('Deleted:', result.deletedCount);
};

// Find and delete (returns deleted document)
const findOneAndDelete = async () => {
  const student = await Student.findOneAndDelete({ 
    email: 'delete@example.com' 
  });
  console.log('Deleted student:', student);
};

// Find by ID and delete
const findByIdAndDelete = async (id) => {
  const student = await Student.findByIdAndDelete(id);
  console.log('Deleted student:', student);
};
```

---

## ðŸŽ¯ Advanced Mongoose Features

### 1. Virtual Properties

Virtuals are document properties that you can get and set but don't persist to MongoDB.

```javascript
const userSchema = new mongoose.Schema({
  firstName: String,
  lastName: String
});

// Create virtual property
userSchema.virtual('fullName').get(function() {
  return `${this.firstName} ${this.lastName}`;
});

// Setter
userSchema.virtual('fullName').set(function(name) {
  const parts = name.split(' ');
  this.firstName = parts[0];
  this.lastName = parts[1];
});

// Enable virtuals in JSON
userSchema.set('toJSON', { virtuals: true });

// Usage
const user = new User({ firstName: 'John', lastName: 'Doe' });
console.log(user.fullName); // "John Doe"
```

### 2. Instance Methods

Methods that can be called on document instances.

```javascript
studentSchema.methods.getFullInfo = function() {
  return `${this.name} (${this.age}) - ${this.dept}`;
};

studentSchema.methods.addSkill = async function(skill) {
  this.skills.push(skill);
  return await this.save();
};

studentSchema.methods.isAdult = function() {
  return this.age >= 18;
};

// Usage
const student = await Student.findOne({ name: 'Mehedi' });
console.log(student.getFullInfo());
await student.addSkill('Docker');
console.log(student.isAdult()); // true
```

### 3. Static Methods

Methods that can be called on the Model itself.

```javascript
studentSchema.statics.findByDept = function(dept) {
  return this.find({ dept: dept });
};

studentSchema.statics.findAdults = function() {
  return this.find({ age: { $gte: 18 } });
};

studentSchema.statics.countByDept = async function(dept) {
  return await this.countDocuments({ dept: dept });
};

studentSchema.statics.getAverageAge = async function() {
  const result = await this.aggregate([
    { $group: { _id: null, avgAge: { $avg: '$age' } } }
  ]);
  return result[0]?.avgAge || 0;
};

// Usage
const cseStudents = await Student.findByDept('CSE');
const adults = await Student.findAdults();
const count = await Student.countByDept('SWE');
const avgAge = await Student.getAverageAge();
```

### 4. Query Helpers

Custom query helpers for chainable queries.

```javascript
studentSchema.query.byDept = function(dept) {
  return this.where({ dept: dept });
};

studentSchema.query.active = function() {
  return this.where({ isActive: true });
};

studentSchema.query.ageRange = function(min, max) {
  return this.where('age').gte(min).lte(max);
};

studentSchema.query.withSkill = function(skill) {
  return this.where({ skills: skill });
};

// Usage - chainable queries
const students = await Student
  .find()
  .byDept('CSE')
  .active()
  .ageRange(20, 25)
  .sort({ name: 1 });

const reactDevs = await Student
  .find()
  .withSkill('React')
  .limit(10);
```

### 5. Middleware (Hooks)

Execute functions before or after certain operations.

```javascript
// Pre-save middleware
studentSchema.pre('save', async function(next) {
  console.log('About to save:', this.name);
  
  // Example: Hash password before saving
  // if (this.isModified('password')) {
  //   this.password = await bcrypt.hash(this.password, 10);
  // }
  
  next();
});

// Post-save middleware
studentSchema.post('save', function(doc, next) {
  console.log('Student saved:', doc.name);
  next();
});

// Pre-find middleware
studentSchema.pre(/^find/, function(next) {
  // Only find active students
  this.where({ isActive: true });
  next();
});

// Pre-remove middleware
studentSchema.pre('remove', async function(next) {
  console.log('About to delete:', this.name);
  // Clean up related data
  next();
});

// Error handling middleware
studentSchema.post('save', function(error, doc, next) {
  if (error.name === 'MongoServerError' && error.code === 11000) {
    next(new Error('Email already exists'));
  } else {
    next(error);
  }
});
```

### 6. Population (Joining Documents)

```javascript
// Define schemas with references
const authorSchema = new mongoose.Schema({
  name: String,
  email: String
});

const bookSchema = new mongoose.Schema({
  title: String,
  author: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'Author'
  },
  coAuthors: [{
    type: mongoose.Schema.Types.ObjectId,
    ref: 'Author'
  }]
});

const Author = mongoose.model('Author', authorSchema);
const Book = mongoose.model('Book', bookSchema);

// Populate single reference
const book = await Book.findOne({ title: 'MongoDB Guide' })
  .populate('author');
console.log(book.author.name);

// Populate multiple references
const bookWithAuthors = await Book.findOne()
  .populate('author')
  .populate('coAuthors');

// Selective population
const bookSelected = await Book.findOne()
  .populate('author', 'name email -_id');

// Nested population
const commentSchema = new mongoose.Schema({
  text: String,
  author: { type: mongoose.Schema.Types.ObjectId, ref: 'User' }
});

const postSchema = new mongoose.Schema({
  title: String,
  author: { type: mongoose.Schema.Types.ObjectId, ref: 'User' },
  comments: [commentSchema]
});

const post = await Post.findOne()
  .populate('author')
  .populate('comments.author');
```

### 7. Aggregation Pipeline

```javascript
// Group by department and count
const deptStats = await Student.aggregate([
  { $group: { 
    _id: '$dept', 
    count: { $sum: 1 },
    avgAge: { $avg: '$age' }
  }},
  { $sort: { count: -1 } }
]);

// Match, group, and project
const cseStats = await Student.aggregate([
  { $match: { dept: 'CSE' } },
  { $group: {
    _id: '$semester',
    students: { $push: '$name' },
    count: { $sum: 1 }
  }},
  { $project: {
    semester: '$_id',
    count: 1,
    students: 1,
    _id: 0
  }}
]);

// Complex aggregation
const skillAnalysis = await Student.aggregate([
  { $unwind: '$skills' },
  { $group: {
    _id: '$skills',
    count: { $sum: 1 },
    students: { $push: '$name' }
  }},
  { $sort: { count: -1 } },
  { $limit: 5 }
]);
```

### 8. Indexes

```javascript
// Create indexes in schema
studentSchema.index({ email: 1 }, { unique: true });
studentSchema.index({ name: 1, dept: 1 });
studentSchema.index({ createdAt: -1 });

// Text index for search
studentSchema.index({ name: 'text', dept: 'text' });

// Usage
const results = await Student.find({ 
  $text: { $search: 'Mehedi CSE' } 
});

// Get indexes
Student.collection.getIndexes().then(indexes => {
  console.log(indexes);
});
```

### 9. Transactions

```javascript
const session = await mongoose.startSession();

try {
  await session.startTransaction();
  
  // Operations within transaction
  const student = await Student.create([{
    name: 'Test',
    email: 'test@example.com',
    age: 20,
    dept: 'CSE'
  }], { session });
  
  await AnotherModel.updateOne(
    { _id: someId },
    { $set: { studentId: student[0]._id } },
    { session }
  );
  
  // Commit transaction
  await session.commitTransaction();
  console.log('âœ… Transaction completed');
} catch (error) {
  // Rollback on error
  await session.abortTransaction();
  console.error('âŒ Transaction failed:', error);
} finally {
  session.endSession();
}
```

### 10. Custom Validators

```javascript
const studentSchema = new mongoose.Schema({
  name: {
    type: String,
    validate: {
      validator: function(v) {
        return /^[a-zA-Z\s]+$/.test(v);
      },
      message: 'Name can only contain letters and spaces'
    }
  },
  email: {
    type: String,
    validate: {
      validator: async function(email) {
        const user = await this.constructor.findOne({ email });
        return !user || user._id.equals(this._id);
      },
      message: 'Email already exists'
    }
  },
  age: {
    type: Number,
    validate: [
      {
        validator: function(v) {
          return v >= 18;
        },
        message: 'Must be 18 or older'
      },
      {
        validator: function(v) {
          return Number.isInteger(v);
        },
        message: 'Age must be an integer'
      }
    ]
  }
});
```

---

## ðŸŒ Complete Express + Mongoose Example

### Project Structure
```
project/
â”œâ”€â”€ config/
â”‚   â””â”€â”€ database.js
â”œâ”€â”€ models/
â”‚   â””â”€â”€ Student.js
â”œâ”€â”€ routes/
â”‚   â””â”€â”€ students.js
â”œâ”€â”€ controllers/
â”‚   â””â”€â”€ studentController.js
â”œâ”€â”€ middleware/
â”‚   â””â”€â”€ errorHandler.js
â”œâ”€â”€ .env
â”œâ”€â”€ app.js
â””â”€â”€ package.json
```

### 1. Database Configuration (config/database.js)
```javascript
const mongoose = require('mongoose');

const connectDB = async () => {
  try {
    const conn = await mongoose.connect(process.env.MONGO_URI || 'mongodb://localhost:27017/school', {
      useNewUrlParser: true,
      useUnifiedTopology: true,
    });
    
    console.log(`âœ… MongoDB Connected: ${conn.connection.host}`);
    
    // Connection events
    mongoose.connection.on('error', (err) => {
      console.error('MongoDB connection error:', err);
    });
    
    mongoose.connection.on('disconnected', () => {
      console.log('MongoDB disconnected');
    });
    
  } catch (error) {
    console.error(`âŒ Error: ${error.message}`);
    process.exit(1);
  }
};

module.exports = connectDB;
```

### 2. Enhanced Model (models/Student.js)
```javascript
const mongoose = require('mongoose');

const studentSchema = new mongoose.Schema({
  name: {
    type: String,
    required: [true, 'Name is required'],
    trim: true,
    minlength: [3, 'Name must be at least 3 characters'],
    maxlength: [50, 'Name cannot exceed 50 characters']
  },
  email: {
    type: String,
    required: [true, 'Email is required'],
    unique: true,
    lowercase: true,
    trim: true,
    match: [/^\S+@\S+\.\S+$/, 'Please provide a valid email']
  },
  age: {
    type: Number,
    required: [true, 'Age is required'],
    min: [18, 'Must be at least 18 years old'],
    max: [100, 'Age cannot exceed 100']
  },
  dept: {
    type: String,
    required: [true, 'Department is required'],
    enum: {
      values: ['CSE', 'SWE', 'EEE', 'Math', 'Physics'],
      message: '{VALUE} is not a valid department'
    }
  },
  skills: {
    type: [String],
    default: []
  },
  semester: {
    type: String,
    enum: ['1st', '2nd', '3rd', '4th', '5th', '6th', '7th', '8th']
  },
  gpa: {
    type: Number,
    min: 0,
    max: 4.0
  },
  isActive: {
    type: Boolean,
    default: true
  },
  address: {
    city: String,
    country: {
      type: String,
      default: 'Bangladesh'
    }
  }
}, {
  timestamps: true,
  toJSON: { virtuals: true },
  toObject: { virtuals: true }
});

// Indexes
studentSchema.index({ email: 1 }, { unique: true });
studentSchema.index({ dept: 1, semester: 1 });
studentSchema.index({ name: 'text', dept: 'text' });

// Virtual - Full info
studentSchema.virtual('info').get(function() {
  return `${this.name} (${this.age}) - ${this.dept}`;
});

// Instance Methods
studentSchema.methods.addSkill = async function(skill) {
  if (!this.skills.includes(skill)) {
    this.skills.push(skill);
    await this.save();
  }
  return this;
};

studentSchema.methods.removeSkill = async function(skill) {
  this.skills = this.skills.filter(s => s !== skill);
  await this.save();
  return this;
};

// Static Methods
studentSchema.statics.findByDept = function(dept) {
  return this.find({ dept, isActive: true });
};

studentSchema.statics.getTopPerformers = function(limit = 10) {
  return this.find({ isActive: true })
    .sort({ gpa: -1 })
    .limit(limit);
};

studentSchema.statics.getDeptStatistics = async function() {
  return await this.aggregate([
    { $match: { isActive: true } },
    { $group: {
      _id: '$dept',
      count: { $sum: 1 },
      avgAge: { $avg: '$age' },
      avgGPA: { $avg: '$gpa' }
    }},
    { $sort: { count: -1 } }
  ]);
};

// Query Helpers
studentSchema.query.byDept = function(dept) {
  return this.where({ dept });
};

studentSchema.query.active = function() {
  return this.where({ isActive: true });
};

studentSchema.query.bySemester = function(semester) {
  return this.where({ semester });
};

// Middleware
studentSchema.pre('save', function(next) {
  console.log(`Saving student: ${this.name}`);
  next();
});

studentSchema.post('save', function(doc) {
  console.log(`Student saved successfully: ${doc._id}`);
});

// Pre-remove hook
studentSchema.pre('remove', async function(next) {
  // Clean up related data if needed
  console.log(`Removing student: ${this.name}`);
  next();
});

const Student = mongoose.model('Student', studentSchema);

module.exports = Student;
```

### 3. Controller (controllers/studentController.js)
```javascript
const Student = require('../models/Student');

// @desc    Get all students
// @route   GET /api/students
exports.getAllStudents = async (req, res, next) => {
  try {
    const { dept, semester, page = 1, limit = 10, sort = '-createdAt' } = req.query;
    
    // Build query
    let query = Student.find();
    
    if (dept) query = query.byDept(dept);
    if (semester) query = query.bySemester(semester);
    
    query = query.active();
    
    // Pagination
    const skip = (page - 1) * limit;
    const students = await query
      .skip(skip)
      .limit(parseInt(limit))
      .sort(sort);
    
    const total = await Student.countDocuments(query.getFilter());
    
    res.status(200).json({
      success: true,
      count: students.length,
      total,
      page: parseInt(page),
      totalPages: Math.ceil(total / limit),
      data: students
    });
  } catch (error) {
    next(error);
  }
};

// @desc    Get single student
// @route   GET /api/students/:id
exports.getStudent = async (req, res, next) => {
  try {
    const student = await Student.findById(req.params.id);
    
    if (!student) {
      return res.status(404).json({
        success: false,
        message: 'Student not found'
      });
    }
    
    res.status(200).json({
      success: true,
      data: student
    });
  } catch (error) {
    next(error);
  }
};

// @desc    Create new student
// @route   POST /api/students
exports.createStudent = async (req, res, next) => {
  try {
    const student = await Student.create(req.body);
    
    res.status(201).json({
      success: true,
      message: 'Student created successfully',
      data: student
    });
  } catch (error) {
    next(error);
  }
};

// @desc    Update student
// @route   PUT /api/students/:id
exports.updateStudent = async (req, res, next) => {
  try {
    const student = await Student.findByIdAndUpdate(
      req.params.id,
      req.body,
      {
        new: true,
        runValidators: true
      }
    );
    
    if (!student) {
      return res.status(404).json({
        success: false,
        message: 'Student not found'
      });
    }
    
    res.status(200).json({
      success: true,
      message: 'Student updated successfully',
      data: student
    });
  } catch (error) {
    next(error);
  }
};

// @desc    Delete student
// @route   DELETE /api/students/:id
exports.deleteStudent = async (req, res, next) => {
  try {
    const student = await Student.findByIdAndDelete(req.params.id);
    
    if (!student) {
      return res.status(404).json({
        success: false,
        message: 'Student not found'
      });
    }
    
    res.status(200).json({
      success: true,
      message: 'Student deleted successfully'
    });
  } catch (error) {
    next(error);
  }
};

// @desc    Add skill to student
// @route   POST /api/students/:id/skills
exports.addSkill = async (req, res, next) => {
  try {
    const student = await Student.findById(req.params.id);
    
    if (!student) {
      return res.status(404).json({
        success: false,
        message: 'Student not found'
      });
    }
    
    await student.addSkill(req.body.skill);
    
    res.status(200).json({
      success: true,
      message: 'Skill added successfully',
      data: student
    });
  } catch (error) {
    next(error);
  }
};

// @desc    Get department statistics
// @route   GET /api/students/stats/departments
exports.getDeptStats = async (req, res, next) => {
  try {
    const stats = await Student.getDeptStatistics();
    
    res.status(200).json({
      success: true,
      data: stats
    });
  } catch (error) {
    next(error);
  }
};

// @desc    Search students
// @route   GET /api/students/search
exports.searchStudents = async (req, res, next) => {
  try {
    const { q } = req.query;
    
    const students = await Student.find({
      $text: { $search: q }
    }).limit(20);
    
    res.status(200).json({
      success: true,
      count: students.length,
      data: students
    });
  } catch (error) {
    next(error);
  }
};
```

### 4. Routes (routes/students.js)
```javascript
const express = require('express');
const router = express.Router();
const {
  getAllStudents,
  getStudent,
  createStudent,
  updateStudent,
  deleteStudent,
  addSkill,
  getDeptStats,
  searchStudents
} = require('../controllers/studentController');

// Special routes first
router.get('/search', searchStudents);
router.get('/stats/departments', getDeptStats);

// CRUD routes
router.route('/')
  .get(getAllStudents)
  .post(createStudent);

router.route('/:id')
  .get(getStudent)
  .put(updateStudent)
  .delete(deleteStudent);

router.post('/:id/skills', addSkill);

module.exports = router;
```

### 5. Error Handler Middleware (middleware/errorHandler.js)
```javascript
const errorHandler = (err, req, res, next) => {
  let error = { ...err };
  error.message = err.message;
  
  console.error(err);
  
  // Mongoose bad ObjectId
  if (err.name === 'CastError') {
    const message = 'Resource not found';
    error = { message, statusCode: 404 };
  }
  
  // Mongoose duplicate key
  if (err.code === 11000) {
    const message = 'Duplicate field value entered';
    error = { message, statusCode: 400 };
  }
  
  // Mongoose validation error
  if (err.name === 'ValidationError') {
    const message = Object.values(err.errors).map(val => val.message);
    error = { message, statusCode: 400 };
  }
  
  res.status(error.statusCode || 500).json({
    success: false,
    error: error.message || 'Server Error'
  });
};

module.exports = errorHandler;
```

### 6. Main App (app.js)
```javascript
const express = require('express');
const dotenv = require('dotenv');
const connectDB = require('./config/database');
const errorHandler = require('./middleware/errorHandler');

// Load env vars
dotenv.config();

// Connect to database
connectDB();

const app = express();

// Body parser middleware
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// Routes
app.use('/api/students', require('./routes/students'));

// Health check
app.get('/health', (req, res) => {
  res.status(200).json({ status: 'OK', message: 'Server is running' });
});

// Error handler (must be last)
app.use(errorHandler);

const PORT = process.env.PORT || 5000;

const server = app.listen(PORT, () => {
  console.log(`ðŸš€ Server running on port ${PORT}`);
});

// Handle unhandled promise rejections
process.on('unhandledRejection', (err) => {
  console.error(`Error: ${err.message}`);
  server.close(() => process.exit(1));
});
```

### 7. Environment Variables (.env)
```env
NODE_ENV=development
PORT=5000
MONGO_URI=mongodb://localhost:27017/school
```

### 8. Package.json
```json
{
  "name": "mongoose-crud-api",
  "version": "1.0.0",
  "description": "Complete Mongoose CRUD API",
  "main": "app.js",
  "scripts": {
    "start": "node app.js",
    "dev": "nodemon app.js"
  },
  "dependencies": {
    "express": "^4.18.2",
    "mongoose": "^7.0.0",
    "dotenv": "^16.0.3"
  },
  "devDependencies": {
    "nodemon": "^2.0.22"
  }
}
```

---

## ðŸ“š API Usage Examples

### Create Student
```bash
POST http://localhost:5000/api/students
Content-Type: application/json

{
  "name": "Mehedi Hasan",
  "email": "mehedi@example.com",
  "age": 22,
  "dept": "CSE",
  "semester": "8th",
  "gpa": 3.75,
  "skills": ["JavaScript", "Node.js", "MongoDB"]
}
```

### Get All Students (with filters)
```bash
GET http://localhost:5000/api/students?dept=CSE&semester=8th&page=1&limit=10
```

### Get Single Student
```bash
GET http://localhost:5000/api/students/507f1f77bcf86cd799439011
```

### Update Student
```bash
PUT http://localhost:5000/api/students/507f1f77bcf86cd799439011
Content-Type: application/json

{
  "age": 23,
  "gpa": 3.80
}
```

### Delete Student
```bash
DELETE http://localhost:5000/api/students/507f1f77bcf86cd799439011
```

### Add Skill
```bash
POST http://localhost:5000/api/students/507f1f77bcf86cd799439011/skills
Content-Type: application/json

{
  "skill": "React"
}
```

### Search Students
```bash
GET http://localhost:5000/api/students/search?q=Mehedi
```

### Get Department Statistics
```bash
GET http://localhost:5000/api/students/stats/departments
```

---

## ðŸŽ“ Best Practices

### 1. **Always Use Environment Variables**
```javascript
// âŒ Bad
mongoose.connect('mongodb://localhost:27017/mydb');

// âœ… Good
mongoose.connect(process.env.MONGO_URI);
```

### 2. **Handle Errors Properly**
```javascript
// âœ… Use try-catch with async/await
try {
  const student = await Student.create(data);
} catch (error) {
  console.error(error);
}

// âœ… Or use .catch() with promises
Student.create(data)
  .then(student => console.log(student))
  .catch(error => console.error(error));
```

### 3. **Use Lean for Read-Only Queries**
```javascript
// Returns plain JavaScript objects (faster)
const students = await Student.find().lean();
```

### 4. **Select Only Required Fields**
```javascript
// Don't fetch unnecessary data
const students = await Student.find().select('name email dept');
```

### 5. **Use Indexes for Frequent Queries**
```javascript
studentSchema.index({ email: 1 });
studentSchema.index({ dept: 1, semester: 1 });
```

### 6. **Validate Data at Schema Level**
```javascript
// Define validation in schema, not in controllers
const schema = new mongoose.Schema({
  email: {
    type: String,
    required: true,
    unique: true,
    lowercase: true
  }
});
```

### 7. **Use Transactions for Multiple Operations**
```javascript
const session = await mongoose.startSession();
session.startTransaction();
try {
  await Student.create([data], { session });
  await OtherModel.updateOne({}, {}, { session });
  await session.commitTransaction();
} catch (error) {
  await session.abortTransaction();
} finally {
  session.endSession();
}
```

---

## ðŸš€ Quick Reference

### Common Mongoose Methods
- **Create**: `create()`, `insertMany()`, `new Model()` + `save()`
- **Read**: `find()`, `findOne()`, `findById()`, `exists()`, `countDocuments()`
- **Update**: `updateOne()`, `updateMany()`, `findByIdAndUpdate()`, `findOneAndUpdate()`
- **Delete**: `deleteOne()`, `deleteMany()`, `findByIdAndDelete()`, `findOneAndDelete()`

### Query Operators
- **Comparison**: `$eq`, `$ne`, `$gt`, `$gte`, `$lt`, `$lte`, `$in`, `$nin`
- **Logical**: `$and`, `$or`, `$not`, `$nor`
- **Element**: `$exists`, `$type`
- **Array**: `$size`, `$all`, `$elemMatch`

### Update Operators
- `$set`, `$unset`, `$inc`, `$push`, `$pull`, `$addToSet`, `$pop`, `$rename`

---

## ðŸ“– Additional Resources

- **MongoDB Official Docs**: https://docs.mongodb.com
- **Mongoose Official Docs**: https://mongoosejs.com
- **MongoDB University**: https://university.mongodb.com (Free courses)
- **Mongoose Schema Types**: https://mongoosejs.com/docs/schematypes.html
- **Mongoose Validation**: https://mongoosejs.com/docs/validation.html

---

## âœ… Conclusion

This guide covers everything from basic MongoDB shell commands to advanced Mongoose features including:
- Complete CRUD operations
- Schema design and validation
- Middleware and hooks
- Virtual properties
- Static and instance methods
- Query helpers
- Population and relationships
- Aggregation pipelines
- Full Express + Mongoose application example

**Happy Coding! ðŸš€**