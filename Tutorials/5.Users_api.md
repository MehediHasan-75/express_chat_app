# How to build a **User Registration Workflow** using **Mongoose**, **Multer**, **Express-validator**, and **Custom Middlewares**.?


# 1ï¸âƒ£ Create Mongoose User Schema (`models/people.js`)

- Create a folder named **models** then add **people.js**

```js
// Import mongoose
const mongoose = require("mongoose");

// Create schema for Users
const peopleSchema = mongoose.Schema(
  {
    // User's name
    name: {
      type: String,
      required: true,
      trim: true, // remove spaces from start & end
    },

    // Unique email for login
    email: {
      type: String,
      required: true,
      trim: true,
      lowercase: true,
    },

    // User's mobile number
    mobile: {
      type: String,
      required: true,
    },

    // Hashed password will be stored here
    password: {
      type: String,
      required: true,
    },

    // Avatar image filename
    avatar: {
      type: String,
    },

    // User role
    role: {
      type: String,
      enum: ["admin", "user"], // allowed values
      default: "user",
    },
  },
  {
    // Auto create createdAt & updatedAt timestamps
    timestamps: true,
  }
);

// Export as model (MongoDB will create 'people' collection automatically only when the first document is inserted, not when you define or export the Mongoose model.)
module.exports = mongoose.model("People", peopleSchema);
```

---

# 2ï¸âƒ£ Add Avatar Upload Middleware (`middleware/users/avatarUpload.js`)

- We need **multer** to handle image uploads.nThis middleware will call the **singleUploader** function.

```js
// This middleware handles avatar uploads using multer
const uploader = require("../../utilities/singleUploader");

function avatarUpload(req, res, next) {
  // Create multer upload object
  const upload = uploader(
    "avatars", // folder name inside uploads
    ["image/jpeg", "image/jpg", "image/png"], // allowed file types
    10000000, // max file size (10MB)
    "Only .jpg, jpeg or .png format allowed!" // error message
  );

  // Call multer upload handler
  upload.any()(req, res, (err) => {
    if (err) {
      // If upload error occurs, return error response
      res.status(500).json({
        errors: {
          avatar: {
            msg: err.message,
          },
        },
      });
    } else {
      // If no error â†’ go to the next middleware
      next();
    }
  });
}

module.exports = avatarUpload;
```

---

# 3ï¸âƒ£ Create the Multer Upload Utility (`utilities/singleUploader.js`)

This utility function generates a reusable multer upload handler.

```js
// External imports
const multer = require("multer");
const path = require("path");
const createError = require("http-errors");

// Custom uploader function
function uploader(subfolder_path, allowed_file_types, max_file_size, error_msg) {
  // Upload directory path
  const UPLOADS_FOLDER = `${__dirname}/../public/uploads/${subfolder_path}/`;

  // Multer disk storage settings
  const storage = multer.diskStorage({
    // Set where file will be saved
    destination: (req, file, cb) => {
      cb(null, UPLOADS_FOLDER);
    },

    // Rename file to prevent duplicates
    filename: (req, file, cb) => {
      const fileExt = path.extname(file.originalname);
      const fileName =
        file.originalname
          .replace(fileExt, "")
          .toLowerCase()
          .split(" ")
          .join("-") +
        "-" +
        Date.now();

      // Final saved filename
      cb(null, fileName + fileExt);
    },
  });

  // Multer upload configuration
  const upload = multer({
    storage: storage,
    limits: {
      fileSize: max_file_size,
    },
    fileFilter: (req, file, cb) => {
      // Check allowed file types
      if (allowed_file_types.includes(file.mimetype)) {
        cb(null, true);
      } else {
        cb(createError(error_msg));
      }
    },
  });

  return upload;
}

module.exports = uploader;
```

---

# 4ï¸âƒ£ Create User Validation Middleware

Create a file:
`middleware/users/addUserValidators.js`

```js
const { check, validationResult } = require("express-validator");
const createError = require("http-errors");
const path = require("path");
const { unlink } = require("fs");
const User = require("../../models/People");

// Validators for adding user
const addUserValidators = [
  // Validate name
  check("name")
    .isLength({ min: 1 })
    .withMessage("Name is required")
    .isAlpha("en-US", { ignore: " -" }) // allow space & hyphen
    .withMessage("Name must only contain alphabets")
    .trim(),

  // Validate email
  check("email")
    .isEmail()
    .withMessage("Invalid email address")
    .trim()
    .custom(async (value) => {
      // Check duplicate email
      const user = await User.findOne({ email: value });
      if (user) {
        throw createError("Email already in use!");
      }
    }),

  // Validate mobile number
  check("mobile")
    .isMobilePhone("bn-BD", { strictMode: true })
    .withMessage("Must be a valid Bangladeshi number")
    .custom(async (value) => {
      // Check duplicate mobile
      const user = await User.findOne({ mobile: value });
      if (user) {
        throw createError("Mobile number already used!");
      }
    }),

  // Validate password
  check("password")
    .isStrongPassword()
    .withMessage(
      "Password must be 8+ chars & contain uppercase, lowercase, number, and symbol"
    ),
];

// Handle validation errors
const addUserValidationHandler = function (req, res, next) {
  const errors = validationResult(req);
  const mappedErrors = errors.mapped();

  if (Object.keys(mappedErrors).length === 0) {
    // If no validation errors â†’ next()
    next();
  } else {
    // If validation fails, delete uploaded avatar
    if (req.files.length > 0) {
      const { filename } = req.files[0];
      unlink(
        path.join(__dirname, `/../public/uploads/avatars/${filename}`),
        () => {}
      );
    }

    // Send error response
    res.status(500).json({
      errors: mappedErrors,
    });
  }
};

module.exports = {
  addUserValidators,
  addUserValidationHandler,
};
```

---

# 5ï¸âƒ£ Create addUser and deleteUser in `controllers/usersController.js`

### Add User

```js
const bcrypt = require("bcrypt");
const path = require("path");
const { unlink } = require("fs");
const User = require("../models/People");

// Add User Controller
async function addUser(req, res, next) {
  // Hash password
  const hashedPassword = await bcrypt.hash(req.body.password, 10);

  // Create new user object
  let newUser = new User({
    ...req.body,
    password: hashedPassword,
    avatar: req.files?.length > 0 ? req.files[0].filename : undefined,
  });

  try {
    // Save user to DB
    await newUser.save();
    res.status(200).json({
      message: "User was added successfully!",
    });
  } catch (err) {
    res.status(500).json({
      errors: {
        common: {
          msg: "Unknown error occurred!",
        },
      },
    });
  }
}
```

---

### Delete User

```js
// Remove user
async function removeUser(req, res, next) {
  try {
    const user = await User.findByIdAndDelete({ _id: req.params.id });

    if (user?.avatar) {
      unlink(
        path.join(__dirname, `/../public/uploads/avatars/${user.avatar}`),
        (err) => {}
      );
    }

    res.status(200).json({ message: "User was removed successfully!" });
  } catch (err) {
    res.status(500).json({
      errors: { common: { msg: "Could not delete the user!" } },
    });
  }
}

module.exports = { addUser, removeUser };
```

---

# 6ï¸âƒ£ Setup Routes (`routers/userRouter.js`)

```js
const express = require("express");
const router = express.Router();

const avatarUpload = require("../middleware/users/avatarUpload");
const {
  addUserValidators,
  addUserValidationHandler,
} = require("../middleware/users/addUserValidators");

const { addUser, removeUser } = require("../controllers/usersController");

router.post(
  "/",
  avatarUpload,
  addUserValidators,
  addUserValidationHandler,
  addUser
);

router.delete("/:id", removeUser);

module.exports = router;
```

---

# How The Flow Works

### 1. Client sends POST `/users/`

Includes:

* name, email, mobile, password â†’ `req.body`
* avatar â†’ `req.files`

### 2. **avatarUpload middleware**

* Handles uploading files using Multer
* Validates file type & size
* If error â†’ send JSON error

### 3. **addUserValidators**

* Validates input fields
* Checks email & mobile uniqueness

### 4. **addUserValidationHandler**

* If validation fails â†’ delete uploaded image

### 5. **addUser controller**

* Hash password
* Save user in DB

---

# ğŸ—‘ Delete User Flow

### DELETE `/users/:id`

1. Removes user from DB
2. If avatar exists â†’ deletes file from uploads folder
3. Returns success message. 
