# ğŸ“Œ Table of Contents
1. [**Middleware Introduction**](#middleware-introduction)
2. [What Is the Express Middleware Stack?](#what-is-the-express-middleware-stack)
3. [How Express Builds the Internal Stack](#how-express-builds-the-internal-stack)
4. [Example App with All Middleware Types](#example-app-with-all-middleware-types)
5. [Internal Stack Order (Actual Flow)](#internal-stack-order-actual-flow)
6. [Request Flow Step-by-Step](#request-flow-step-by-step)
7. [404 Handling Flow](#404-handling-flow)
8. [Error Handling Flow](#error-handling-flow)
9. [Diagram: Complete Request Lifecycle](#diagram-complete-request-lifecycle)
---
# â­ Middleware Introduction

Middleware in Express is **any function that sits between the request and the response**.
Every request that enters your application passes through a **pipeline of middleware functions**, one after another, **in the exact order they were added**.

A middleware function always has this signature:

```
(req, res, next)
```

or for error handlers:

```
(err, req, res, next)
```

### âœ” What middleware can do

* Read/modify `req` object
* Read/modify `res` object
* Run code
* Access databases
* Parse cookies, JSON, forms, headers
* Serve static files
* Authenticate users
* Handle errors
* Decide whether to continue (`next()`) or stop the request by sending a response

### âœ” Types of middleware in Express

1. **Built-in** â€“ `express.json()`, `express.urlencoded()`, `express.static()`
2. **3rd-party** â€“ `cookie-parser`, `cors`, `helmet`, etc.
3. **Custom middleware** â€“ functions you write yourself
4. **Router-level middleware** â€“ inside an Express Router
5. **Error-handling middleware** â€“ `(err, req, res, next)`

### âœ” How Express decides which middleware to call

* All normal middleware â†’ `(req, res, next)`
* If `next(error)` is used â†’ Express switches to **error-handling mode**
* Error handlers â†’ functions with **four parameters**: `(err, req, res, next)`

> In Express, **everything except the server creation `const app = express();` itself is middleware**.

# What Is the Express Middleware Stack?

When you create an Express app:

```js
const app = express();
```
Express internally creates an **empty array**:

```
middlewareStack = []
```

Every time you call:

```js
app.use(...)
app.get(...)
app.post(...)
router.use(...)
router.get(...)
```
Express **pushes a new layer** into this stack **in order**.
Every incoming request moves **from top to bottom** of this list.

---

# â­ How Express Builds the Internal Stack

Every middleware or route you add becomes one "layer":

| Code                       | Added To Stack As                       |
| -------------------------- | --------------------------------------- |
| `app.use(express.json())`  | Built-in parser layer                   |
| `app.use('/user', router)` | Router layer + routerâ€™s internal layers |
| `app.get('/home', ...)`    | Route handler layer                     |
| `app.use(notFoundHandler)` | 404 middleware                          |
| `app.use(errorHandler)`    | Error-handling layer (4 parameters)     |

---

# â­ Example App With All Middleware Types

```js
const express = require("express");
const cookieParser = require("cookie-parser");
const path = require("path");

const app = express();

/* -------------------------------------------
   1. Built-in Middleware
-------------------------------------------- */
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

/* -------------------------------------------
   2. Third-party Middleware
-------------------------------------------- */
app.use(cookieParser("SECRET_KEY"));

/* -------------------------------------------
   3. Custom Global Middleware
-------------------------------------------- */
app.use((req, res, next) => {
    console.log("Global logger â†’", req.method, req.url);
    next();
});

/* -------------------------------------------
   4. Static Middleware
-------------------------------------------- */
app.use(express.static(path.join(__dirname, "public")));

/* -------------------------------------------
   5. Router-Level Middleware + Routes
-------------------------------------------- */
const router = express.Router();

router.use((req, res, next) => {
    console.log("Router-level middleware hit");
    next();
});

router.get("/profile", (req, res) => {
    res.send("User Profile Page");
});

app.use("/user", router);

/* -------------------------------------------
   6. Route Handlers
-------------------------------------------- */
app.get("/", (req, res) => {
    res.send("Home Page");
});

app.post("/submit", (req, res) => {
    res.send("Form Submitted");
});

/* -------------------------------------------
   7. Async Route (Error Example)
-------------------------------------------- */
app.get("/async-error", async (req, res, next) => {
    try {
        throw new Error("Async Error!");
    } catch (err) {
        next(err);  // triggers error mode
    }
});

/* -------------------------------------------
   8. Global Middleware (After Routes)
-------------------------------------------- */
app.use((req, res, next) => {
    console.log("Middleware after all routes");
    next();
});

/* -------------------------------------------
   9. 404 Handler (Normal Middleware)
-------------------------------------------- */
app.use((req, res, next) => {
    const err = new Error("Route Not Found");
    err.status = 404;
    next(err);
});

/* -------------------------------------------
   10. Final Error Handler (4 Params)
-------------------------------------------- */
app.use((err, req, res, next) => {
    console.log("Error Handler Triggered â†’", err.message);
    res.status(err.status || 500).send({
        status: "error",
        message: err.message
    });
});

app.listen(3000, () => console.log("Server runningâ€¦"));
```

---

# â­ Internal Stack Order (Actual Flow)

Express creates this stack **in the exact order you wrote it**:

```
0 â†’ express.json()
1 â†’ express.urlencoded()
2 â†’ cookieParser()
3 â†’ global logger
4 â†’ express.static(/public)
5 â†’ router-level middleware (inside /user router)
6 â†’ /user/profile route
7 â†’ GET /
8 â†’ POST /submit
9 â†’ GET /async-error
10 â†’ post-route-global middleware
11 â†’ 404 handler
12 â†’ error handler
```

---

# â­ Request Flow Step-by-Step

### Example Request:

```
GET /user/profile
```

Execution goes like this:

```
0 â†’ express.json()
1 â†’ express.urlencoded()
2 â†’ cookieParser()
3 â†’ global logger
4 â†’ static middleware
5 â†’ router-level middleware
6 â†’ /user/profile route â†’ RESPONSE SENT
```

Stops here because response is finished.

---

### Another Request:

```
GET /unknown
```

Flow:

```
0 â†’ json
1 â†’ urlencoded
2 â†’ cookies
3 â†’ logger
4 â†’ static
5 â†’ router middleware (path mismatch)
6 â†’ skip
7 â†’ skip
8 â†’ skip
9 â†’ skip
10 â†’ post-route logger
11 â†’ 404 handler â†’ next(error)
12 â†’ error handler â†’ ERROR RESPONSE SENT
```

---

# â­ 404 Handling Flow

404 middleware is a **normal middleware**:

```js
app.use((req, res, next) => {
    const err = new Error("Not Found");
    err.status = 404;
    next(err);
});
```

### How Express handles 404:

1. All routes are checked
2. No route matches
3. Express reaches this middleware
4. It creates an error
5. Calls `next(err)`
6. Express switches to **error mode**

---

# â­ Error Handling Flow (4 Arguments)

Error handlers must have **4 parameters**:

```js
function errorHandler(err, req, res, next) { ... }
```

Express logic:

* If `next()` â†’ continue normally
* If `next(error)` â†’ **skip all normal middleware**
* Jump to the next middleware with **4 parameters**

Error handlers always run **last**.

---

# â­ Diagram: Complete Request Lifecycle

```
Incoming Request
       â†“
[ Built-in Middleware ]
       â†“
[ 3rd-party Middleware ]
       â†“
[ Custom Global Middleware ]
       â†“
[ Static File Middleware ]
       â†“
[ Router-Level Middleware ]
       â†“
[ Routes (GET, POST, etc.) ]
       â†“
Match Found?
   â”œâ”€â”€ YES â†’ Send Response â†’ END
   â””â”€â”€ NO  â†’ Continue
       â†“
[ Global Middleware (after routes) ]
       â†“
[ 404 Middleware â†’ next(error) ]
       â†“
[ Error Handler (4 params) ]
       â†“
Send Error Response
       â†“
END
```